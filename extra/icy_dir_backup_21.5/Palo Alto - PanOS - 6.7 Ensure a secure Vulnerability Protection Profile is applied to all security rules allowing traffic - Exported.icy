L cd %%DBL%% tout60

L curl -k -i -X GET 'https://%%HOST%%/api/?type=keygen&user=%%USER%%&password=%%PASSWORD%%' \> tempkey tout60

L sed -n 's/.*<key>\([^<]*\)<\/key>.*/\1/p' tempkey \> key tout60

L curl -k "https://%%HOST%%/api/?type=op&cmd=<show><config><effective-running><xpath>devices/entry%5B%40name%3D%27localhost.localdomain%27%5D/vsys</xpath></effective-running></config></show>&key=`cat key`" | tee response tout60

L xmlstarlet sel -t -v "//result/vsys/entry/@name" -n response > vsys_list tout60

L cat vsys_list | wc -l V> %%VSYS_COUNTER%% tout60

L head -1 vsys_list; sed -i '1d' vsys_list V> %%VSYS_NAME%% tout60

L xmlstarlet sel -t -c "//result/vsys/entry[@name='%%VSYS_NAME%%']" -n response > vsys_conf tout60

L xmlstarlet sel -t -v "//rulebase/security/rules/entry/@name" -n vsys_conf > policies tout60

L cat policies | sed '/^$/d' | wc -l V> %%COUNTER%%

I if (%%COUNTER%% equal 0) gotoline 19 100  tout60
# VSYS has no security policies

L head -1 policies; sed -i '1d' policies V> %%POLICY%% tout60

L xmlstarlet sel -t -v "//rules/entry[@name='%%POLICY%%']/profile-setting/group/member" -n vsys_conf V> %%PROF_GROUP%%  tout60
# if profile group is set

L if (%%PROF_GROUP%% isempty) xmlstarlet sel -t -v "//rules/entry[@name='%%POLICY%%']/profile-setting/profiles/vulnerability/member" -n vsys_conf V> %%VULN_PROF%%  tout60
# if profile is set directly

L if (%%PROF_GROUP%% isnotempty) xmlstarlet sel -t -v "//profile-group/entry[@name='%%PROF_GROUP%%']/vulnerability/member" -n vsys_conf V> %%VULN_PROF%%  tout60
# get profile from group

L if (%%VULN_PROF%% isempty) echo "VSYS %%VSYS_NAME%%: Policy %%POLICY%% - no Vulnerability Protection profile set" >> issues tout60

L echo "$((%%COUNTER%% - 1))" V> %%COUNTER%%

I if (%%COUNTER%% greater 0) gotoline 12 1500 tout60

L echo "$((%%VSYS_COUNTER%% - 1))" V> %%VSYS_COUNTER%% tout60

I if (%%VSYS_COUNTER%% greater 0) gotoline 7 100 tout60

L cat issues V> %%ISSUES%% tout60

L cd %%DBL%%; ls | grep -v logs | tee /dev/tty | xargs rm -rf  tout60
# Cleanup

L if (%%ISSUES%% notcontains such file) echo '%%ISSUES%%'  tout60
* F:%%ISSUES%%

L if (%%ISSUES%% contains such file) echo 'All security policies accross all VSYS have a Vulnerability Protection profile applied'  tout60
* S:All security policies accross all VSYS have a Vulnerability Protection profile applied
