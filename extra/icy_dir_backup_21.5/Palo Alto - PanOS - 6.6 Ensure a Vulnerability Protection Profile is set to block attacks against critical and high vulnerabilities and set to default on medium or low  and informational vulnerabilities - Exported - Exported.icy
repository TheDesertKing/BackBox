L cd %%DBL%%

L curl -k -i -X GET 'https://%%HOST%%/api/?type=keygen&user=%%USER%%&password=%%PASSWORD%%' \> tempkey tout60

L sed -n 's/.*<key>\([^<]*\)<\/key>.*/\1/p' tempkey \> key

L curl -k "https://%%HOST%%/api/?type=config&action=get&xpath=/config/devices/entry%5B%40name%3D%27localhost.localdomain%27%5D/vsys/entry%5B%40name%3D%27vsys1%27%5D/profiles/vulnerability&key=`cat key`" | tee response tout60

L xmlstarlet sel -t -m "//vulnerability/entry" -v "@name" -n response > profiles

L cat profiles | wc -l V> %%COUNTER%%

L cat profiles | head -1; sed -i '1d' profiles V> %%PROFILE%%

L xmlstarlet sel -t -m "//vulnerability/entry[@name='%%PROFILE%%']//entry[action/block-ip]" -v "@name" -n response > action_block

L xmlstarlet sel -t -m "//vulnerability/entry[@name='%%PROFILE%%']//entry[host/text()='any']" -v "@name" -n response > host_type_any

L xmlstarlet sel -t -m "//vulnerability/entry[@name='%%PROFILE%%']//entry[cve/member/text()='any']" -v "@name" -n response > cve_any

L xmlstarlet sel -t -m "//vulnerability/entry[@name='%%PROFILE%%']//entry[vendor-id/member/text()='any']" -v "@name" -n response > vendor_id_any

L xmlstarlet sel -t -m "//vulnerability/entry[@name='%%PROFILE%%']//entry[severity[member/text()='critical'][member/text()='high']]" -v "@name" -n response > severity_block

L xmlstarlet sel -t -m "//vulnerability/entry[@name='%%PROFILE%%']//entry[action/default]" -v "@name" -n response > action_default

L xmlstarlet sel -t -m "//vulnerability/entry[@name='%%PROFILE%%']//entry[severity[member/text()='medium'][member/text()='low'][member/text()='informational']]" -v "@name" -n response > severity_default

L cat action_block host_type_any cve_any vendor_id_any severity_block | sed '/^$/d' | sort | uniq -c | awk '{if($1==5) print $2}' \> good_block

L cat action_default host_type_any cve_any vendor_id_any severity_default | sed '/^$/d' | sort | uniq -c | awk '{if($1==5) print $2}' \> good_default

L cat good_block | wc -l V> %%BLOCK_COUNT%%

L cat good_default | wc -l V> %%DEFAULT_COUNT%%

L if (%%BLOCK_COUNT%% greater 0 AND %%DEFAULT_COUNT%% greater 0) echo "%%PROFILE%%" >> good_profiles

L echo $((%%COUNTER%% - 1)) V> %%COUNTER%%

I if (%%COUNTER%% greater 0) gotoline 7 100

L cat good_profiles V> %%GOOD_PROFILES%%

L echo "No Spyware Profiles matching the criteria found:\na block rule containing:\n\taction:block\n\thost type:any\n\tcve:any\n\tvendor id:any\n\tcategory:any\n\tseverity:critical,high (at least)\n\na default rule containing:\n\taction:default\n\thost type:any\n\thost type:any\n\tcve:any\n\tvendor id:any\n\tcategory:any\n\tseverity: medium,low,information" V> %%FAIL_MSG%%

L echo -e "No Spyware Profiles matching the criteria found:\na block rule containing:\n\taction:block\n\thost type:any\n\tcve:any\n\tvendor id:any\n\tcategory:any\n\tseverity:critical,high (at least)\n\na default rule containing:\n\taction:default\n\thost type:any\n\thost type:any\n\tcve:any\n\tvendor id:any\n\tcategory:any\n\tseverity: medium,low,information" V> %%FAIL_MSG_STATUS%%

L rm -rf %%DBL%%/*

L if (%%GOOD_PROFILES%% isempty OR %%GOOD_PROFILES%% contains such file) echo -e "%%FAIL_MSG%%" 
* F:%%FAIL_MSG_STATUS%%

L if (%%GOOD_PROFILES%% isnotempty AND %%GOOD_PROFILES%% notcontains such file) echo "Correct Anti Spyware Profiles found: %%GOOD_PROFILES%%" 
* S:Correct Anti Spyware Profiles found: %%GOOD_PROFILES%%
