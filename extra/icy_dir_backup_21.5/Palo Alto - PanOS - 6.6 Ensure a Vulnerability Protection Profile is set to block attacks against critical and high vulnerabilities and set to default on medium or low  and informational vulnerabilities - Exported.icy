L cd %%DBL%%

L curl -k -i -X GET 'https://%%HOST%%/api/?type=keygen&user=%%USER%%&password=%%PASSWORD%%' \> tempkey tout60

L sed -n 's/.*<key>\([^<]*\)<\/key>.*/\1/p' tempkey \> key

L curl -k "https://%%HOST%%/api/?type=op&cmd=<show><config><effective-running><xpath>devices/entry%5B%40name%3D%27localhost.localdomain%27%5D/vsys</xpath></effective-running></config></show>&key=`cat key`" | tee response tout60

L xmlstarlet sel -t -v "//result/vsys/entry/@name" -n response > vsys_list

L cat vsys_list | wc -l V> %%VSYS_COUNTER%%

L head -1 vsys_list; sed -i '1d' vsys_list V> %%VSYS_NAME%%

L xmlstarlet sel -t -c "//result/vsys/entry[@name='%%VSYS_NAME%%']" -n response > vsys_conf

L xmlstarlet sel -t -v "//profiles/vulnerability/entry/@name" -n vsys_conf > profiles

L cat profiles | sed '/^$/d' | wc -l V> %%COUNTER%%

I if (%%COUNTER%% equal 0) gotoline 27 100 
# VSYS has no vulnerability profiles

L head -1 profiles; sed -i '1d' profiles V> %%PROFILE%%

L xmlstarlet sel -t -m "//profiles/vulnerability/entry[@name='%%PROFILE%%']//entry[action/block-ip]" -v "@name" -n vsys_conf > action_block

L xmlstarlet sel -t -m "//profiles/vulnerability/entry[@name='%%PROFILE%%']//entry[host/text()='any']" -v "@name" -n vsys_conf > host_type_any

L xmlstarlet sel -t -m "//profiles/vulnerability/entry[@name='%%PROFILE%%']//entry[cve/member/text()='any']" -v "@name" -n vsys_conf > cve_any

L xmlstarlet sel -t -m "//profiles/vulnerability/entry[@name='%%PROFILE%%']//entry[vendor-id/member/text()='any']" -v "@name" -n vsys_conf > vendor_id_any

L xmlstarlet sel -t -m "//profiles/vulnerability/entry[@name='%%PROFILE%%']//entry[severity[member/text()='critical'][member/text()='high']]" -v "@name" -n vsys_conf > severity_block

L xmlstarlet sel -t -m "//profiles/vulnerability/entry[@name='%%PROFILE%%']//entry[action/default]" -v "@name" -n vsys_conf > action_default

L xmlstarlet sel -t -m "//profiles/vulnerability/entry[@name='%%PROFILE%%']//entry[severity[member/text()='medium'][member/text()='low'][member/text()='informational']]" -v "@name" -n vsys_conf > severity_default

L cat action_block host_type_any cve_any vendor_id_any severity_block | sed '/^$/d' | sort | uniq -c | awk '{if($1==5) print $2}' \> good_block

L cat action_default host_type_any cve_any vendor_id_any severity_default | sed '/^$/d' | sort | uniq -c | awk '{if($1==5) print $2}' \> good_default

L cat good_block | wc -l V> %%BLOCK_COUNT%%

L cat good_default | wc -l V> %%DEFAULT_COUNT%%

L if (%%BLOCK_COUNT%% greater 0 AND %%DEFAULT_COUNT%% greater 0) echo "%%PROFILE%%" >> good_profiles

L echo $((%%COUNTER%% - 1)) V> %%COUNTER%%

I if (%%COUNTER%% greater 0) gotoline 12 100

L echo "$((%%VSYS_COUNTER%% - 1))" V> %%VSYS_COUNTER%%

I if (%%VSYS_COUNTER%% greater 0) gotoline 7 100

L cat good_profiles V> %%GOOD_PROFILES%%

L cd %%DBL%%; ls | grep -v logs | tee /dev/tty | xargs rm -rf 
# Cleanup

L if (%%GOOD_PROFILES%% isempty OR %%GOOD_PROFILES%% contains such file) echo -e 'No Vulnerability Protection profiles matching the criteria found:\nA block rule containing:\n\taction:block\n\thost type:any\n\tcve:any\n\tvendor id:any\n\tcategory:any\n\tseverity:critical,high (at least)\n\nA default rule containing:\n\taction:default\n\thost type:any\n\thost type:any\n\tcve:any\n\tvendor id:any\n\tcategory:any\n\tseverity: medium,low,information' 
* F:No Spyware Profiles matching the criteria found:%%ENTER%%a block rule containing:%%ENTER%%\taction:block%%ENTER%%\thost type:any%%ENTER%%\tcve:any%%ENTER%%\tvendor id:any%%ENTER%%\tcategory:any%%ENTER%%\tseverity:critical,high (at least)%%ENTER%%%%ENTER%%a default rule containing:%%ENTER%%\taction:default%%ENTER%%\thost type:any%%ENTER%%\thost type:any%%ENTER%%\tcve:any%%ENTER%%\tvendor id:any%%EN

L if (%%GOOD_PROFILES%% isnotempty AND %%GOOD_PROFILES%% notcontains such file) echo -e 'Found Vulnerability Protection profiles that are set to block attacks against critical and high vulnerabilities, and set to default on medium, low and informational, vulnerabilities:\n%%GOOD_PROFILES%%' 
* S:Found Vulnerability Protection profiles that are set to block attacks against critical and high vulnerabilities, and set to default on medium, low and informational, vulnerabilities:%%ENTER%%%%GOOD_PROFILES%%
